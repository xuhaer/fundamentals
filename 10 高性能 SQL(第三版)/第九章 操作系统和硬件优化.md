# 第九章 操作系统和硬件优化

## 9.3 平衡内存和磁盘资源

**配置大量内存最大的原因**其实不是因为可以在内存中保存大量数据:最终目的**是避免磁盘IO**,因为磁盘I/O比在内存中访问数据要慢得多。关键是要平衡内存和磁盘的大小、速度、成本和其他因素,以便为工作负载提供高性能的表现。



### 9.3.1 随机IO和顺序IO

数据库服务器同时使用顺序和随机IO,随机IO从缓存中受益最多。想像有一个典型的混合工作负载,均衡地包含单行査找与多行范围扫描,可以说服自己相信这个说法。典型的情况是“热点”数据随机分布。因此,缓存这些数据将有助于避免昂贵的磁盘寻道。相反,顺序读取一般只需要扫描一次数据,所以缓存对它是没用的,除非能完全放在内存中缓存起来。



顺序读取不能从缓存中受益的另一个原因是它们比随机读快。这有以下两个原因:

*  顺序IO比随机IO快。

  顺序操作的执行速度比随机操作快,无论是在内存还是磁盘上。假设磁盘每秒可以做100个随机I/O操作,并且可以完成每秒50MB的顺序读取(这大概是消费级磁盘现在能达到的水平)。如果每行100字节,随机读每秒可以读100行,相比之下顺序读可以每秒读500000行——是随机读的5000倍,或几个数量级的差异。因此,在这种情况下随机IO可以从缓存中获得很多好处。

  顺序访问内存行的速度也快于随机访问。现在的内存芯片通常每秒可以随机访问约250000次100字节的行,或者每秒500万次的顺序访问。请注意,内存随机访问速度比磁盘随机访问快了2500倍,而内存中顺序访问只有磁盘10倍的速度。

* 存储引擎执行顺序读比随机读快。

  一个随机读一般意味着存储引擎必须执行索引操作。(这个规则也有例外,但对InnoDB和 MyISAM都是对的)。通常需要通过B树的数据结构查找,并且和其他值比较。相反,连续读取一般需要遍历一个简单的数据结构,例如链表。这样就少了很多工作,反复这样操作,连续读取的速度就比随机读取要快了。

最后,随机读取通常只要查找特定的行,但不仅仅只读取一行——而是要读取一整页的数据,其中大部分是不需要的。这浪费了很多工作。另一方面,顺序读取数据,通常发生在想要的页面上的所有行,所以更符合成本效益。

综上所述,通过缓存顺序读取可以节省一些工作,但缓存随机读取可以节省更多的工作。



### 9.3.2 缓存，读和写

如果有足够的内存,就完全可以避免磁盘读取请求。如果所有的数据文件都可以放在内存中,一旦服务器缓存“热”起来了,所有的读操作都会在缓存命中。虽然还是会有逻辑读取,不过物理读取就没有了。但写入是不同的问题。写入可以像读一样在内存中完成,但迟早要被写入到磁盘,所以它是需要持久化的。换句话说,缓存可延缓写入,但不能像消除读取一样消除写入。

### 9.3.5 选择硬盘

如果无法满足让足够的数据在内存中的目标——例如,估计将需要500GB的内存才能完全让CPU负载起当前的IO系统—那么应该考虑一个更强大的IO子系统,有时甚至要以牺牲内存为代价,同时应用程序的设计应该能处理IO等待。这听起来似乎有悖常理。毕竟,我们刚刚说过,更多的内存可以缓解IO子系统的压力,并减少I/O等待。为什么要加强I/O子系统呢,如果只增加内存能解决问题吗?答案就在所涉及的因素之间的平衡,例如读写之间的平衡,每个IO操作的大小,以及每秒有多少这样的操作发生。例如,若需要快速写日志,就不能通过增加大量有效内存来避免磁盘写入。在这种情况下,投资一个高性能的IO系统与带电池支持的写缓存或固态存储,可能是个更好的主意。



**作为一个简要回顾,从传统磁盘读取数据的过程分为三个步骤:**

1. 移动读取磁头到磁盘表面上的正确位置。
2. 等待磁盘旋转,所有所需的数据在读取磁头下。
3. 等待磁盘旋转过去,所有所需的数据都被读取磁头读出。

磁盘执行这些操作的速度可以浓缩为两个数字:访问时间(步骤1和2合并)和传输速度。这两个数字也决定延迟和吞吐量。从完成一次磁盘读取所需要的总时间来说,小的随机查找以步骤1和2为主,而大的顺序读主要是第3步。

注：在所有其他条件相同的情况下，磁盘的物理尺寸也会带来差别 ：越小的磁盘，移动读取磁头需要 的时间就更短。同其他条件的情况，2.5英寸的硬盘速度是要快于3.5寸的，还可以节省电力。

### 9.4 固态存储

固态存储设备采用非易失性闪存芯片而不是磁性盘片组成。它们也被称为 NVRAM,或非易失性随机存取存储器。固态存储设备没有移动部件,这使得它们表现得跟硬盘驱动器有很大的不同。

目前 MySQL用户感兴趣的技术可分为两大类:SSD(固态硬盘)和PCle卡。SSD通过实现SATA(串行高级技术附件)接口来模拟标准硬盘,所以可以替代硬盘驱动器,直接插入服务器机箱中的现有插槽。PCIe卡使用特殊的操作系统驱动程序,把存储设备作为一个块设备输出。PCIe和SSD设备有时可以简单地都认为是SSD。

**下面是闪存性能的快速小结。高质量闪存设备具备:**

* 相比硬盘有更好的随机读写性能。闪存设备通常读明显比写要快。
* 相比硬盘有更好的顺序读写性能。但是相比而言不如随机I/O的改善那么大,因为硬盘随机IO比顺序IO要慢得多。入门级固态硬盘的顺序读取实际上还可能比传统硬盘慢。
* 相比硬盘能更好地支持并发。闪存设备可以支持更多的并发操作,事实上,只有大量的并发请求才能真正实现最大吞吐量。

**其中最重要的是提升随机 I/O 和并发性。因此，固态存储最适合使用在任何有着大量随机 I/O 工作负载的场景下。**而像 InnoDB日志文件这样的顺序写的工作负载，SSD 并不能提供多少成本与性能优势，因为在这种情况下，SSD 连续写方面不比普通硬盘快多少，而这却会更快耗尽 SSD 的寿命。我们可以尽可能将随机 I/O 集中到SSD设备上，然后把大部分顺序写入的压力尽可能转移出SSD。

此外， 如果在闪存上运行 MySQL,有一些配置参数可以提供更好的性能。 InnoDB的默认配置从实践来看是为硬盘驱动器定制的,而不是为固态硬盘定制的。改进包括：

* 增加InnoDB 的 I/O 容量
* 让InnoDB的日志文件更大
* 把一些文件从 SSD 移到 RAID
* 禁用预读
* 配置 InnoDB 的刷新算法
* 禁用双写缓存的可能
* 限制插入缓冲的大小

等等





